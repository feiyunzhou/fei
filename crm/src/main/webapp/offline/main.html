<!DOCTYPE html>
<html manifest="cache.appcache" dir="ltr" lang="zh-CN">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<link href='../fullcalendar/fullcalendar.css' rel='stylesheet' />
<link href='../fullcalendar/fullcalendar.print.css' rel='stylesheet' media='print' />
<link href="../jquery/css/smoothness/jquery-ui-1.10.2.custom.css" rel="stylesheet">
<script src='../jquery/js/jquery-1.9.1.js'></script>
<script src='../jquery/js/jquery-ui-1.10.2.custom.min.js'></script>
<!-- <script src='../jquery-ui-bootstrap/js/jquery-ui-1.9.2.custom.min.js'></script> -->
<script src='../fullcalendar/fullcalendar.min.js'></script>
<script src='../js/dataclient.js'></script>
<script src="../bootstrap/js/bootstrap.js"></script>
<link href="../bootstrap/css/bootstrap.css" rel="stylesheet" media="screen">

<script type="text/javascript" src="../bootstrap-timepicker/js/bootstrap-timepicker.js"></script>
<link type="text/css" href="../bootstrap-timepicker/css/bootstrap-timepicker.css" />

<script type="text/javascript" src="../bootstrap-datetimepicker/js/bootstrap-datetimepicker.min.js"></script>
<link type="text/css" href="../bootstrap-datetimepicker/css/bootstrap-datetimepicker.min.css" />

<script src="../datatable/js/jquery.dataTables.min.js"></script>
<link type="text/css" href="../datatable/css/jquery.dataTables.css" />

<script src="../datatable/js/dataTables.bootstrap.js"></script>
<link type="text/css" href="../datatable/css/dataTables.bootstrap.css" />

<script>
    var isOnline;
    $(document).ready(function() {
        if (window.applicationCache) {
            applicationCache.addEventListener('updateready', function() {
                if (confirm('An update is available. Reload now?')) {
                    window.location.reload();
                }
            });
        }

        window.applicationCache.addEventListener('checking', logEvent, false);
        window.applicationCache.addEventListener('noupdate', logEvent, false);
        window.applicationCache.addEventListener('downloading', logEvent, false);
        window.applicationCache.addEventListener('progress', logEvent, false);
        window.applicationCache.addEventListener('cached', logEvent, false);
        window.applicationCache.addEventListener('updateready', logEvent, false);
        window.applicationCache.addEventListener('obsolete', logEvent, false);
        window.applicationCache.addEventListener('error', logEvent, false);

        function logEvent(event) {
            console.log(event.type);
        }

        $('#myTab a').click(function(e) {
            e.preventDefault();
            $(this).tab('show');
        });

        $("#dialog").dialog({
            width : 320,
            height : 450,
            buttons : [ {
                text : "Ok",
                click : function() {
                    var starttime = $("#datestr").val() + " " + $("#from").val();
                    var endtime = $("#datestr").val() + " " + $("#to").val();
                    console.log("from:" + starttime + " to:" + endtime);
                    var event = {};
                    event.title = "拜访";
                    event.start = starttime;
                    event.end = endtime;
                    $('#calendar').fullCalendar('renderEvent', event, true);
                    $('#calendar').fullCalendar('rerenderEvents');
                    $('#calendar').fullCalendar('refetchEvents');
                    $(this).dialog("close");

                    var type = "拜访";

                    var userEvent = {
                        title : "拜访",
                        crmUserId : "20",
                        start : starttime,
                        end : endtime,
                        allDay : false
                    };

                    if (navigator.onLine) {
                        //save event to the server
                        var code = postEvent(userEvent);
                        if (code === 0) {
                            getRemoteEvents();
                        }

                    } else {

                        var ed = localStorage["events"];
                        ed = JSON.parse(ed);
                        ed.push(userEvent);
                        setLocalStorage(ed);

                    }
                }
            }, {
                text : "Cancel",
                click : function() {
                    $(this).dialog("close");
                }
            } ],
            autoOpen : false
        });

        function postEvent(userEvent) {
            var args = {};
            args.f = "setEvent";
            args.p = [ userEvent.crmUserId, "visit", userEvent.title, userEvent.start, userEvent.end ];
            ajaxPost(args, function onAjaxComplete(resp) {
                console.log(resp);
                if (resp.code == 0) {
                    console.log("set event successfully");

                } else {
                    console.log("failed to set event");
                }

                return resp.code;
            });
        }
        /* initialize the calendar
        -----------------------------------------------------------------*/

        $('#calendar').fullCalendar({
            header : {
                left : 'prev,next today',
                center : 'title',
                right : 'month,agendaWeek,agendaDay'
            },
            editable : true,
            droppable : true, // this allows things to be dropped onto the calendar !!!
            drop : function(date, allDay) { // this function is called when something is dropped

                // retrieve the dropped element's stored Event Object
                var originalEventObject = $(this).data('eventObject');

                // we need to copy it, so that multiple events don't have a reference to the same object
                var copiedEventObject = $.extend({}, originalEventObject);

                // assign it the date that was reported
                copiedEventObject.start = date;
                copiedEventObject.allDay = allDay;

                // render the event on the calendar
                // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
                $('#calendar').fullCalendar('renderEvent', copiedEventObject, true);

                // is the "remove after drop" checkbox checked?
                if ($('#drop-remove').is(':checked')) {
                    // if so, remove the element from the "Draggable Events" list
                    $(this).remove();
                }
                console.log("get view:" + ($(this).fullCalendar('getView')).title);

                $("#dialog").dialog("open");

            },

            dayClick : function(date, allDay, jsEvent, view) {

                if (allDay) {
                    console.log('Clicked on the entire day: ' + date);
                } else {
                    console.log('Clicked on the slot: ' + date);
                }

                console.log('Coordinates: ' + jsEvent.pageX + ',' + jsEvent.pageY);

                console.log('Current view: ' + view.name);

                // change the day's background color just for fun
                // $(this).css('background-color', 'red');

                var clickdate = $.fullCalendar.formatDate(date, "yyyy-MM-dd");
                $("#datestr").val(clickdate);
                $("#datestr").text(clickdate);
                //$("#dialog").attr("title", clickdate);
                $("#dialog").dialog('open');
                //$('#myModal').modal();

            }
        });

        function checkOnline() {
            var args = {};
            args.f = "ping";
            args.p = [];
            ajaxPost2(args, function onComplete(resp) {
                isOnline = true;
            }, function onError(status) {
                isOnline = false;
            });

            return (navigator.onLine && isOnline);
        }

        if (navigator.onLine) {
            console.log("online");

            //query localstorage to get the local event which not send to the serve when offline
            var localevents = localStorage["events"];
            if (localevents != null) {
                localevents = JSON.parse(localevents);
                var eventswithoutid = [];
                if ((localevents != null) && (localevents.length > 0)) {
                    for ( var i = 0; i < localevents.length; i++) {
                        if ((typeof localevents[i].id === 'undefined') || localevents[i].id == null) {
                            eventswithoutid.push(localevents[i]);
                        }
                    }
                }
                console.log("eventswithoutid");
                console.log(eventswithoutid);
                if (eventswithoutid.length > 0) {
                    var resp = -1;
                    for ( var i = 0; i < eventswithoutid.length; i++) {
                        resp = postEvent(eventswithoutid[i]);
                    }
                    if (resp === 0) {
                        localStorage["events"] == [];
                    }
                }
            }

            getRemoteEvents();

        } else {
            console.log("Offline");
            var ed = localStorage["events"];
            console.log(ed);
            if (jQuery.isEmptyObject(ed) === false) {
                console.log("here it is");
                var neweventdata = JSON.parse(ed);
                console.log(neweventdata);
                renderCalendar(neweventdata);

            }

        }

        function getRemoteEvents() {
            var args = {};
            args.f = "getEventsByUserId";
            args.p = [ "20" ];
            ajaxPost(args, function onAjaxComplete(eventData) {
                console.log(eventData);
                if (eventData.length > 0) {
                    setLocalStorage(eventData);
                    renderCalendar(eventData);
                }
            });
        }

        function setLocalStorage(etData) {
            var dupData = [];
            for ( var i = 0; i < etData.length; i++) {
                var tmpEv = {
                    title : etData[i].title,
                    id : etData[i].id,
                    start : etData[i].start,
                    end : etData[i].end,
                    crmUserId : etData[i].crmUserId

                };
                dupData.push(tmpEv);
            }
            localStorage["events"] = JSON.stringify(dupData);
        }
        
        
        function renderCalendar(eventdata) {
            //$('#calendar').fullCalendar( 'render' );
            //remove all events on calendar
            $('#calendar').fullCalendar('removeEvents', function filter(event) {
                //console.log("remove" + event.id);
                return true;
            });

            for ( var i = 0; i < eventdata.length; i++) {
                //console.log(data[i]);
                $('#calendar').fullCalendar('renderEvent', eventdata[i], true);
            }
            $('#calendar').fullCalendar('render');

            /*  $('#calendar').fullCalendar({
                events:eventdata
             });  */
        }

        $("#testbut").on("click", function(event) {
            console.log("but clicked");
            alert(navigator.onLine);
        });

        $("#refreshbt").on("click", function(event) {
            window.location.reload();
        });

        
        // Begin of contact typeahead 
        function setContact2LocalStorage(data) {
            localStorage["crmcontacts"] = JSON.stringify(data);
        }
        
        function getContactsFromLocalStorage(data) {
            return JSON.parse(localStorage["crmcontacts"]);
        }
        
        var selected_contact_id;
        function renderContactTypeaheadWithDataRemote() {
            var args = {};
            args.f = "getContactData";
            args.p = [ '20' ];
            ajaxPost2(args, function onComplete(resp) {
                isOnline = true;
                setContact2LocalStorage(resp);
                renderContactTypeahead(resp);
            }, function onError(status) {
                isOnline = false;
                renderContactTypeaheadWithDataLocal();
            });
        }
         
        function renderContactTypeaheadWithDataLocal() {
            var contacts = getContactsFromLocalStorage();
            if(jQuery.isEmptyObject(contacts) === false){
            renderContactTypeahead(contacts);
            }
        }
        
        
        
        function renderContactTypeahead(contacts_data){
            //set type ahead
            var contacts = [];
            var map = {};
            $('#contact_search').typeahead({
                source : function(query, process) {
                    $.each(contacts_data, function(i, contact) {
                        map[contact.name] = contact;
                        contacts.push(contact.name);
                    });
                    process(contacts);
                },
                updater : function(item) {
                    selected_contact_id = map[item].id;
                    console.log("selected id:" + selected_contact_id);
                    return item;
                },

                highlighter : function(item) {
                    return item + " - " + map[item].accountBelongTo;
                },
            });
        }
        
        
        $('#datetimepickerfrom,#datetimepickerto').datetimepicker({
            pickDate : false,
            pickSeconds : false
        });
        
        if (navigator.onLine) {
            renderContactTypeaheadWithDataRemote();
            
        }else{
            renderContactTypeaheadWithDataLocal();
        }
        
        //END of contact typeahead 
         
        
        //Start to render account table
        function renderAccountTableWithDataRemote(){
            var args = {};
            args.f = "getAccountTable";
            args.p = ['20'];
            ajaxPost2(args, function onComplete(data) {
                if(jQuery.isEmptyObject(data) === false){
                    setAccountTable2Localstorage(data);
                    $('#dt_account').dataTable(data);
                }
            }, function onError(status) {
                isOnline = false;
                renderAccountTableWithDataLocal();
            });
        }
        
        function renderAccountTableWithDataLocal(){
            var accountTableData = getAccountTableFromLocalstorage();
            if(jQuery.isEmptyObject(accountTableData) === false){
                $('#dt_account').dataTable(accountTableData);
            }
        }
        
        function setAccountTable2Localstorage(data){
            localStorage["accounttable"] = JSON.stringify(data);
        }
        
        function getAccountTableFromLocalstorage(){
            return JSON.parse(localStorage["accounttable"]);
        }
        
        if (navigator.onLine) {
            renderAccountTableWithDataRemote();
        }else{
            renderAccountTableWithDataLocal();
        }
        // END of render account table
        
        
        //Start to render contact table
        function renderContactTableWithDataRemote(){
            var args = {};
            args.f = "getContactTable";
            args.p = ['20'];
            ajaxPost2(args, function onComplete(data) {
              if(jQuery.isEmptyObject(data) === false){
                  setContactTable2Localstorage(data);
                  $('#dt_contact').dataTable(data);
              }
            }, function onError(status) {
                isOnline = false;
                renderContactTableWithDataLocal();
            });
        }
        
        function renderContactTableWithDataLocal(){
            var contactTableData = getContactTableFromLocalstorage();
            if(jQuery.isEmptyObject(contactTableData) === false){
                $('#dt_contact').dataTable(contactTableData);
            }
        }
        
        function setContactTable2Localstorage(data){
            localStorage["contacttable"] = JSON.stringify(data);
        }
        
        function getContactTableFromLocalstorage(){
            return JSON.parse(localStorage["contacttable"]);
        }
        
        if (navigator.onLine) {
            renderContactTableWithDataRemote();
        }else{
            renderContactTableWithDataLocal();
        }
        // END of render contact table
        
        
        
        
        

    });
</script>
<style type="text/css">
body {
	padding-top: 60px;
	padding-bottom: 40px;
}

.sidebar-nav {
	padding: 9px 0;
}

@media ( max-width : 980px) {
	/* Enable use of floated navbar text */
	.navbar-text.pull-right {
		float: none;
		padding-left: 5px;
		padding-right: 5px;
	}
}
</style>
</head>
<title>CRM</title>
<body>

	<div class="navbar navbar-fixed-top">
		<div class="navbar-inner">
			<div class="container-fluid">
				<button type="button" class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
					<span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span>
				</button>
				<a class="brand" href="#">CRM Offline</a>
				<div class="nav-collapse collapse">
					<p class="navbar-text pull-right">
						<a href="#" class="navbar-link">杰伦，你好！</a>
					</p>

				</div>
				<!--/.nav-collapse -->
			</div>
		</div>
	</div>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
				<div class="pull-right">
					<button class="btn btn-mini" id="refreshbt">刷新</button>
				</div>
				<ul class="nav nav-tabs" id="myTab">
					<li class="active"><a href="#home">日历</a></li>
					<li><a href="#profile">医院</a></li>
					<li><a href="#messages">医生</a></li>
					<li><a href="#intro">展示</a></li>
				</ul>

				<div class="tab-content">
					<div class="tab-pane active" id="home">
						<div id='calendar'></div>
					</div>
					<div class="tab-pane" id="profile">
						<table wicket:id="data" id="dt_account" class="table table-hover table-striped table-bordered table-condensed">
						</table>
					</div>
					<div class="tab-pane" id="messages">
					    <table wicket:id="data" id="dt_contact" class="table table-hover table-striped table-bordered table-condensed">
						</table>
					</div>
					<div class="tab-pane" id="intro">
						<div id="myCarousel" class="carousel slide">
							<ol class="carousel-indicators">
								<li data-target="#myCarousel" data-slide-to="0" class="active"></li>
								<li data-target="#myCarousel" data-slide-to="1"></li>
								<li data-target="#myCarousel" data-slide-to="2"></li>
							</ol>
							<!-- Carousel items -->
							<div class="carousel-inner">
								<div class="item active">
									<img src="../image/bootstrap-mdo-sfmoma-01.jpg" alt="">
									<div class="carousel-caption">
										<h4>第一页</h4>
										<p>说明1</p>
									</div>
								</div>
								<div class="item">
									<img src="../image/bootstrap-mdo-sfmoma-02.jpg" alt="">
									<div class="carousel-caption">
										<h4>第二页</h4>
										<p>说明2</p>
									</div>
								</div>
								<div class="item">
									<img src="../image/bootstrap-mdo-sfmoma-03.jpg" alt="">
									<div class="carousel-caption">
										<h4>第三页</h4>
										<p>说明3</p>
									</div>
								</div>
							</div>
							<!-- Carousel nav -->
							<a class="carousel-control left" href="#myCarousel" data-slide="prev">&lsaquo;</a> <a class="carousel-control right" href="#myCarousel" data-slide="next">&rsaquo;</a>
						</div>
					</div>
				</div>
			</div>

		</div>
		<!--/row-->

		<hr>

		<footer>
			<p>&copy; Company 2013</p>
		</footer>

	</div>
	<!--/.fluid-container-->

	<div id="dialog" title="活动">
		<div>
			<label id="datestr"></label>

			<div class="control-group">
				<label class="control-label" for="from">医生：</label>
				<div class="controls">
					<input id="contact_search" type="text" name="contact" class="input-small">
				</div>
			</div>
			<div class="control-group">
				<label class="control-label" for="from">开始时间：</label>
				<div id="datetimepickerfrom" class="input-append">
					<input id="from" name="from" data-format="hh:mm:ss" type="text" class="input-small"></input> <span class="add-on"> <i data-time-icon="icon-time" data-date-icon="icon-calendar"> </i>
					</span>
				</div>

			</div>
			<div class="control-group">
				<label class="control-label" for="to">结束时间：</label>
				<div id="datetimepickerto" class="input-append">
					<input id="to" name="to" data-format="hh:mm:ss" type="text" class="input-small"></input> <span class="add-on"> <i data-time-icon="icon-time" data-date-icon="icon-calendar"> </i>
					</span>
				</div>
			</div>
			<div class="control-group">
				<label class="control-label">拜访类型</label>
				<div class="controls">
					<select class="input-small">
						<option>拜访</option>
						<option>会议</option>
					</select>
				</div>
			</div>
		</div>
	</div>
	<!-- modal dialog end -->
	<a id="testbut" href="#">Loading...</a>
</body>
</html>